- hosts: [nodes]
  remote_user: duboc_au
  tasks:
  - name: "get last bytes ipv4 ip address"
    shell:  echo $(ip a | grep -E -o "([0-9]{1,3}[\.]){3}[0-9]{1,3}" | grep "157.159" | head -n 1 | cut -d'.' -f4)
    register: num

  - name: "get virtual machine name"
    shell:  echo "vm{{num}}.qcow2"
    register: name

  - debug: 
       var: name

  - name: "get ram"
    shell:  echo $(free -m | tail -n 2 | head -n 1 | awk '{print $2}')
    register: ram
  
  - name: "get cpu"
    shell: echo $(( $(lscpu | grep Proces | awk '{print $2}') * $(lscpu | grep Thread | cut -d':' -f2 | awk '{print $1}') ))
    register: cpu

  - name: "copy qcow on remote serv"
    copy:
      src: ../vm1.qcow2
      dest: ~/vm{{ num }}.qcow2

  - name: "launch virtual machine"
    command: >
            qemu-system-x86_64 -cpu host -machine type=q35,accel=kvm -m {{ ram }} 
            -smp {{ cpu }} -object rng-random,id=rng0,filename=/dev/urandom 
            -device virtio-rng-pci,rng=rng0 -net nic -net bridge,br=virbr0 
            -drive file=vm1.qcow2,if=ide,index=0,media=disk,format=qcow2 
            -balloon virtio -vga cirrus

  - name: "update network config on host"
    shell: ssh moog@192.168.122.2

